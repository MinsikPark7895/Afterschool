pipeline {
    agent any

    tools {
        nodejs 'NodeJS'
    }

    stages {
        stage('ğŸš€ ì‹œì‘') {
            steps {
                echo '=================================================='
                echo '          AfterSchool í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘         '
                echo '=================================================='

                checkout scm
            }
        }

        stage('ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜') {
            steps {
                echo ''
                echo '======= npm ì˜ì¡´ì„± ì„¤ì¹˜ ======='

                dir('frontend/afterschool') {
                    echo 'ğŸ“¦ package.json í™•ì¸...'
                    sh 'ls -la package*.json'

                    echo 'ğŸ“¥ npm íŒ¨í‚¤ì§€ ì„¤ì¹˜...'
                    sh 'npm ci --silent'
                    echo 'âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ'
                }

                echo '======= ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ ======='
                echo ''
            }
        }

        stage('âš›ï¸ React ë¹Œë“œ') {
            steps {
                echo ''
                echo '======= React ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ======='

                dir('frontend/afterschool') {
                    echo 'ğŸ—ï¸ React í”„ë¡œë•ì…˜ ë¹Œë“œ...'
                    sh 'npm run build 2>/dev/null || npm run build'

                    echo 'ğŸ“Š ë¹Œë“œ ê²°ê³¼ í™•ì¸...'
                    sh 'ls -la build/'
                    echo 'âœ… React ë¹Œë“œ ì™„ë£Œ'
                }

                echo '======= React ë¹Œë“œ ì™„ë£Œ ======='
                echo ''
            }
        }
    }

    post {
        success {
            echo ''
            echo '=================================================='
            echo 'ğŸ‰ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì´í”„ë¼ì¸ ì„±ê³µ!'
            echo 'ğŸ“ ë¹Œë“œ íŒŒì¼ì´ build/ ë””ë ‰í† ë¦¬ì— ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤'
            echo '=================================================='
            updateGitlabCommitStatus name: 'frontend', state: 'success'
        }
        failure {
            echo ''
            echo 'âŒ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!'
            echo 'ğŸ” ìœ„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”.'
            updateGitlabCommitStatus name: 'frontend', state: 'failed'
        }
        always {
            cleanWs()
        }
    }
}