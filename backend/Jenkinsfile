pipeline {
    agent any

    environment {
        IMAGE_NAME = 'afterschool-backend'
        CONTAINER_NAME = 'backend'
    }

    stages {
        stage('ğŸš€ ì‹œì‘') {
            steps {
                echo '=================================================='
                echo '           AfterSchool ë°±ì—”ë“œ ë¹Œë“œ ì‹œì‘            '
                echo '=================================================='

                checkout scm
            }
        }

        stage('ğŸ”¨ Spring Boot ë¹Œë“œ') {
            steps {
                echo ''
                echo '======= Gradle ë¹Œë“œ ì‹œì‘ ======='

                dir('backend') {
                    echo 'ğŸ”§ Gradle ì‹¤í–‰ ê¶Œí•œ ì„¤ì •...'
                    sh 'chmod +x ./gradlew'

                    echo 'ğŸ—ï¸ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ...'
                    sh './gradlew build -x test --quiet'
                    echo 'âœ… ë¹Œë“œ ì™„ë£Œ'
                }

                echo '======= Gradle ë¹Œë“œ ì™„ë£Œ ======='
                echo ''
            }
        }

        stage('ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸') {
            steps {
                echo ''
                echo '======= í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ======='

                dir('backend') {
                    echo 'ğŸ§ª JUnit í…ŒìŠ¤íŠ¸ ì‹¤í–‰...'
                    sh './gradlew test --console=plain --quiet'
                    echo 'âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ'
                }

                echo '======= í…ŒìŠ¤íŠ¸ ì™„ë£Œ ======='
                echo ''
            }
            post {
                always {
                    dir('backend') {
                        junit testResults: 'build/test-results/test/*.xml', allowEmptyResults: true
                    }
                }
            }
        }

        stage('ğŸ³ Docker ì´ë¯¸ì§€') {
            steps {
                echo ''
                echo '======= Docker ì´ë¯¸ì§€ ìƒì„± ======='

                dir('backend') {
                    echo 'ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ...'
                    sh """
                        docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} . --quiet
                        docker tag ${IMAGE_NAME}:${BUILD_NUMBER} ${IMAGE_NAME}:latest
                    """
                    echo 'âœ… Docker ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ'
                }

                echo '======= Docker ì´ë¯¸ì§€ ì™„ë£Œ ======='
                echo ''
            }
        }
    }

    post {
        success {
            echo ''
            echo '=================================================='
            echo 'ğŸ‰ ë°±ì—”ë“œ íŒŒì´í”„ë¼ì¸ ì„±ê³µ!'
            echo '=================================================='
            updateGitlabCommitStatus name: 'backend', state: 'success'
        }
        failure {
            echo ''
            echo 'âŒ ë°±ì—”ë“œ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!'
            echo 'ğŸ” ìœ„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”.'
            updateGitlabCommitStatus name: 'backend', state: 'failed'
        }
        always {
            cleanWs()
        }
    }
}